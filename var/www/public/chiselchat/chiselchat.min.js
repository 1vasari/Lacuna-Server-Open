(function(){var e=this,t=e._,n={},a=Array.prototype,i=Object.prototype,r=Function.prototype,s=a.push,o=a.slice,c=a.concat,l=i.toString,u=i.hasOwnProperty,h=a.forEach,d=a.map,f=a.reduce,m=a.reduceRight,p=a.filter,v=a.every,_=a.some,g=a.indexOf,y=a.lastIndexOf,b=Array.isArray,R=Object.keys,I=r.bind,C=function(e){return e instanceof C?e:this instanceof C?(this._wrapped=e,void 0):new C(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=C),exports._=C):e._=C,C.VERSION="1.4.4";var w=C.each=C.forEach=function(e,t,a){if(null!=e)if(h&&e.forEach===h)e.forEach(t,a);else if(e.length===+e.length){for(var i=0,r=e.length;r>i;i++)if(t.call(a,e[i],i,e)===n)return}else for(var s in e)if(C.has(e,s)&&t.call(a,e[s],s,e)===n)return};C.map=C.collect=function(e,t,n){var a=[];return null==e?a:d&&e.map===d?e.map(t,n):(w(e,function(e,i,r){a[a.length]=t.call(n,e,i,r)}),a)};var M="Reduce of empty array with no initial value";C.reduce=C.foldl=C.inject=function(e,t,n,a){var i=arguments.length>2;if(null==e&&(e=[]),f&&e.reduce===f)return a&&(t=C.bind(t,a)),i?e.reduce(t,n):e.reduce(t);if(w(e,function(e,r,s){i?n=t.call(a,n,e,r,s):(n=e,i=!0)}),!i)throw new TypeError(M);return n},C.reduceRight=C.foldr=function(e,t,n,a){var i=arguments.length>2;if(null==e&&(e=[]),m&&e.reduceRight===m)return a&&(t=C.bind(t,a)),i?e.reduceRight(t,n):e.reduceRight(t);var r=e.length;if(r!==+r){var s=C.keys(e);r=s.length}if(w(e,function(o,c,l){c=s?s[--r]:--r,i?n=t.call(a,n,e[c],c,l):(n=e[c],i=!0)}),!i)throw new TypeError(M);return n},C.find=C.detect=function(e,t,n){var a;return x(e,function(e,i,r){return t.call(n,e,i,r)?(a=e,!0):void 0}),a},C.filter=C.select=function(e,t,n){var a=[];return null==e?a:p&&e.filter===p?e.filter(t,n):(w(e,function(e,i,r){t.call(n,e,i,r)&&(a[a.length]=e)}),a)},C.reject=function(e,t,n){return C.filter(e,function(e,a,i){return!t.call(n,e,a,i)},n)},C.every=C.all=function(e,t,a){t||(t=C.identity);var i=!0;return null==e?i:v&&e.every===v?e.every(t,a):(w(e,function(e,r,s){return(i=i&&t.call(a,e,r,s))?void 0:n}),!!i)};var x=C.some=C.any=function(e,t,a){t||(t=C.identity);var i=!1;return null==e?i:_&&e.some===_?e.some(t,a):(w(e,function(e,r,s){return i||(i=t.call(a,e,r,s))?n:void 0}),!!i)};C.contains=C.include=function(e,t){return null==e?!1:g&&e.indexOf===g?-1!=e.indexOf(t):x(e,function(e){return e===t})},C.invoke=function(e,t){var n=o.call(arguments,2),a=C.isFunction(t);return C.map(e,function(e){return(a?t:e[t]).apply(e,n)})},C.pluck=function(e,t){return C.map(e,function(e){return e[t]})},C.where=function(e,t,n){return C.isEmpty(t)?n?null:[]:C[n?"find":"filter"](e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},C.findWhere=function(e,t){return C.where(e,t,!0)},C.max=function(e,t,n){if(!t&&C.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.max.apply(Math,e);if(!t&&C.isEmpty(e))return-1/0;var a={computed:-1/0,value:-1/0};return w(e,function(e,i,r){var s=t?t.call(n,e,i,r):e;s>=a.computed&&(a={value:e,computed:s})}),a.value},C.min=function(e,t,n){if(!t&&C.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.min.apply(Math,e);if(!t&&C.isEmpty(e))return 1/0;var a={computed:1/0,value:1/0};return w(e,function(e,i,r){var s=t?t.call(n,e,i,r):e;a.computed>s&&(a={value:e,computed:s})}),a.value},C.shuffle=function(e){var t,n=0,a=[];return w(e,function(e){t=C.random(n++),a[n-1]=a[t],a[t]=e}),a};var j=function(e){return C.isFunction(e)?e:function(t){return t[e]}};C.sortBy=function(e,t,n){var a=j(t);return C.pluck(C.map(e,function(e,t,i){return{value:e,index:t,criteria:a.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,a=t.criteria;if(n!==a){if(n>a||void 0===n)return 1;if(a>n||void 0===a)return-1}return e.index<t.index?-1:1}),"value")};var U=function(e,t,n,a){var i={},r=j(t||C.identity);return w(e,function(t,s){var o=r.call(n,t,s,e);a(i,o,t)}),i};C.groupBy=function(e,t,n){return U(e,t,n,function(e,t,n){(C.has(e,t)?e[t]:e[t]=[]).push(n)})},C.countBy=function(e,t,n){return U(e,t,n,function(e,t){C.has(e,t)||(e[t]=0),e[t]++})},C.sortedIndex=function(e,t,n,a){n=null==n?C.identity:j(n);for(var i=n.call(a,t),r=0,s=e.length;s>r;){var o=r+s>>>1;i>n.call(a,e[o])?r=o+1:s=o}return r},C.toArray=function(e){return e?C.isArray(e)?o.call(e):e.length===+e.length?C.map(e,C.identity):C.values(e):[]},C.size=function(e){return null==e?0:e.length===+e.length?e.length:C.keys(e).length},C.first=C.head=C.take=function(e,t,n){return null==e?void 0:null==t||n?e[0]:o.call(e,0,t)},C.initial=function(e,t,n){return o.call(e,0,e.length-(null==t||n?1:t))},C.last=function(e,t,n){return null==e?void 0:null==t||n?e[e.length-1]:o.call(e,Math.max(e.length-t,0))},C.rest=C.tail=C.drop=function(e,t,n){return o.call(e,null==t||n?1:t)},C.compact=function(e){return C.filter(e,C.identity)};var T=function(e,t,n){return w(e,function(e){C.isArray(e)?t?s.apply(n,e):T(e,t,n):n.push(e)}),n};C.flatten=function(e,t){return T(e,t,[])},C.without=function(e){return C.difference(e,o.call(arguments,1))},C.uniq=C.unique=function(e,t,n,a){C.isFunction(t)&&(a=n,n=t,t=!1);var i=n?C.map(e,n,a):e,r=[],s=[];return w(i,function(n,a){(t?a&&s[s.length-1]===n:C.contains(s,n))||(s.push(n),r.push(e[a]))}),r},C.union=function(){return C.uniq(c.apply(a,arguments))},C.intersection=function(e){var t=o.call(arguments,1);return C.filter(C.uniq(e),function(e){return C.every(t,function(t){return C.indexOf(t,e)>=0})})},C.difference=function(e){var t=c.apply(a,o.call(arguments,1));return C.filter(e,function(e){return!C.contains(t,e)})},C.zip=function(){for(var e=o.call(arguments),t=C.max(C.pluck(e,"length")),n=Array(t),a=0;t>a;a++)n[a]=C.pluck(e,""+a);return n},C.object=function(e,t){if(null==e)return{};for(var n={},a=0,i=e.length;i>a;a++)t?n[e[a]]=t[a]:n[e[a][0]]=e[a][1];return n},C.indexOf=function(e,t,n){if(null==e)return-1;var a=0,i=e.length;if(n){if("number"!=typeof n)return a=C.sortedIndex(e,t),e[a]===t?a:-1;a=0>n?Math.max(0,i+n):n}if(g&&e.indexOf===g)return e.indexOf(t,n);for(;i>a;a++)if(e[a]===t)return a;return-1},C.lastIndexOf=function(e,t,n){if(null==e)return-1;var a=null!=n;if(y&&e.lastIndexOf===y)return a?e.lastIndexOf(t,n):e.lastIndexOf(t);for(var i=a?n:e.length;i--;)if(e[i]===t)return i;return-1},C.range=function(e,t,n){1>=arguments.length&&(t=e||0,e=0),n=arguments[2]||1;for(var a=Math.max(Math.ceil((t-e)/n),0),i=0,r=Array(a);a>i;)r[i++]=e,e+=n;return r},C.bind=function(e,t){if(e.bind===I&&I)return I.apply(e,o.call(arguments,1));var n=o.call(arguments,2);return function(){return e.apply(t,n.concat(o.call(arguments)))}},C.partial=function(e){var t=o.call(arguments,1);return function(){return e.apply(this,t.concat(o.call(arguments)))}},C.bindAll=function(e){var t=o.call(arguments,1);return 0===t.length&&(t=C.functions(e)),w(t,function(t){e[t]=C.bind(e[t],e)}),e},C.memoize=function(e,t){var n={};return t||(t=C.identity),function(){var a=t.apply(this,arguments);return C.has(n,a)?n[a]:n[a]=e.apply(this,arguments)}},C.delay=function(e,t){var n=o.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},C.defer=function(e){return C.delay.apply(C,[e,1].concat(o.call(arguments,1)))},C.throttle=function(e,t){var n,a,i,r,s=0,o=function(){s=new Date,i=null,r=e.apply(n,a)};return function(){var c=new Date,l=t-(c-s);return n=this,a=arguments,0>=l?(clearTimeout(i),i=null,s=c,r=e.apply(n,a)):i||(i=setTimeout(o,l)),r}},C.debounce=function(e,t,n){var a,i;return function(){var r=this,s=arguments,o=function(){a=null,n||(i=e.apply(r,s))},c=n&&!a;return clearTimeout(a),a=setTimeout(o,t),c&&(i=e.apply(r,s)),i}},C.once=function(e){var t,n=!1;return function(){return n?t:(n=!0,t=e.apply(this,arguments),e=null,t)}},C.wrap=function(e,t){return function(){var n=[e];return s.apply(n,arguments),t.apply(this,n)}},C.compose=function(){var e=arguments;return function(){for(var t=arguments,n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},C.after=function(e,t){return 0>=e?t():function(){return 1>--e?t.apply(this,arguments):void 0}},C.keys=R||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)C.has(e,n)&&(t[t.length]=n);return t},C.values=function(e){var t=[];for(var n in e)C.has(e,n)&&t.push(e[n]);return t},C.pairs=function(e){var t=[];for(var n in e)C.has(e,n)&&t.push([n,e[n]]);return t},C.invert=function(e){var t={};for(var n in e)C.has(e,n)&&(t[e[n]]=n);return t},C.functions=C.methods=function(e){var t=[];for(var n in e)C.isFunction(e[n])&&t.push(n);return t.sort()},C.extend=function(e){return w(o.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},C.pick=function(e){var t={},n=c.apply(a,o.call(arguments,1));return w(n,function(n){n in e&&(t[n]=e[n])}),t},C.omit=function(e){var t={},n=c.apply(a,o.call(arguments,1));for(var i in e)C.contains(n,i)||(t[i]=e[i]);return t},C.defaults=function(e){return w(o.call(arguments,1),function(t){if(t)for(var n in t)null==e[n]&&(e[n]=t[n])}),e},C.clone=function(e){return C.isObject(e)?C.isArray(e)?e.slice():C.extend({},e):e},C.tap=function(e,t){return t(e),e};var k=function(e,t,n,a){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof C&&(e=e._wrapped),t instanceof C&&(t=t._wrapped);var i=l.call(e);if(i!=l.call(t))return!1;switch(i){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var r=n.length;r--;)if(n[r]==e)return a[r]==t;n.push(e),a.push(t);var s=0,o=!0;if("[object Array]"==i){if(s=e.length,o=s==t.length)for(;s--&&(o=k(e[s],t[s],n,a)););}else{var c=e.constructor,u=t.constructor;if(c!==u&&!(C.isFunction(c)&&c instanceof c&&C.isFunction(u)&&u instanceof u))return!1;for(var h in e)if(C.has(e,h)&&(s++,!(o=C.has(t,h)&&k(e[h],t[h],n,a))))break;if(o){for(h in t)if(C.has(t,h)&&!s--)break;o=!s}}return n.pop(),a.pop(),o};C.isEqual=function(e,t){return k(e,t,[],[])},C.isEmpty=function(e){if(null==e)return!0;if(C.isArray(e)||C.isString(e))return 0===e.length;for(var t in e)if(C.has(e,t))return!1;return!0},C.isElement=function(e){return!(!e||1!==e.nodeType)},C.isArray=b||function(e){return"[object Array]"==l.call(e)},C.isObject=function(e){return e===Object(e)},w(["Arguments","Function","String","Number","Date","RegExp"],function(e){C["is"+e]=function(t){return l.call(t)=="[object "+e+"]"}}),C.isArguments(arguments)||(C.isArguments=function(e){return!(!e||!C.has(e,"callee"))}),true&&(C.isFunction=function(e){return"function"==typeof e}),C.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},C.isNaN=function(e){return C.isNumber(e)&&e!=+e},C.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==l.call(e)},C.isNull=function(e){return null===e},C.isUndefined=function(e){return void 0===e},C.has=function(e,t){return u.call(e,t)},C.noConflict=function(){return e._=t,this},C.identity=function(e){return e},C.times=function(e,t,n){for(var a=Array(e),i=0;e>i;i++)a[i]=t.call(n,i);return a},C.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var E={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};E.unescape=C.invert(E.escape);var N={escape:RegExp("["+C.keys(E.escape).join("")+"]","g"),unescape:RegExp("("+C.keys(E.unescape).join("|")+")","g")};C.each(["escape","unescape"],function(e){C[e]=function(t){return null==t?"":(""+t).replace(N[e],function(t){return E[e][t]})}}),C.result=function(e,t){if(null==e)return null;var n=e[t];return C.isFunction(n)?n.call(e):n},C.mixin=function(e){w(C.functions(e),function(t){var n=C[t]=e[t];C.prototype[t]=function(){var e=[this._wrapped];return s.apply(e,arguments),S.call(this,n.apply(C,e))}})};var A=0;C.uniqueId=function(e){var t=++A+"";return e?e+t:t},C.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var L=/(.)^/,D={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},F=/\\|'|\r|\n|\t|\u2028|\u2029/g;C.template=function(e,t,n){var a;n=C.defaults({},n,C.templateSettings);var i=RegExp([(n.escape||L).source,(n.interpolate||L).source,(n.evaluate||L).source].join("|")+"|$","g"),r=0,s="__p+='";e.replace(i,function(t,n,a,i,o){return s+=e.slice(r,o).replace(F,function(e){return"\\"+D[e]}),n&&(s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),a&&(s+="'+\n((__t=("+a+"))==null?'':__t)+\n'"),i&&(s+="';\n"+i+"\n__p+='"),r=o+t.length,t}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{a=Function(n.variable||"obj","_",s)}catch(o){throw o.source=s,o}if(t)return a(t,C);var c=function(e){return a.call(this,e,C)};return c.source="function("+(n.variable||"obj")+"){\n"+s+"}",c},C.chain=function(e){return C(e).chain()};var S=function(e){return this._chain?C(e).chain():e};C.mixin(C),w(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=a[e];C.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!=e&&"splice"!=e||0!==n.length||delete n[0],S.call(this,n)}}),w(["concat","join","slice"],function(e){var t=a[e];C.prototype[e]=function(){return S.call(this,t.apply(this._wrapped,arguments))}}),C.extend(C.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),this.ChiselchatDefaultTemplates=this.ChiselchatDefaultTemplates||{},this.ChiselchatDefaultTemplates["templates/layout-full.html"]=function(obj){obj||(obj={});var __p="",__e=_.escape;with(obj)__p+="<div id='chiselchat'>\n<ul id='chiselchat-tab-list'>\n<li id='chiselchat-room-tab'>\n<a href='#chiselchat-room-pane' data-toggle='tab' title='Rooms'>Rooms</a>\n</li>\n<li id='chiselchat-presence-tab'>\n<a href='#chiselchat-presence-pane' data-toggle='tab' title='People'>People</a>\n</li>\n</ul>\n<div id='chiselchat-tab-content' class='tab-content'>\n<div id='chiselchat-presence-pane' class='chiselchat-tab-pane'>\n<div class=\"chiselchat-title\">\nPeople\n<span class=\"chiselchat-pane-controls\">\n<a href='javascript: void(0);' data-event='chiselchat-minimize-pane' class='chiselchat-minimize-pane' title='Minimize'>&UnderBar;</a>\n<a href='javascript: void(0);' data-event='chiselchat-toggle-pane-size' class='chiselchat-toggle-pane-size' title='Toggle Chat Window Size'>&uhblk;</a>\n</span>\n</div>\n<div class=\"chiselchat-scrollable-list\"><form id='chiselchat-user-search-form'>\n<input type='text' data-event='chiselchat-user-search' data-template='templates/user-search-list-item.html' data-target='chiselchat-user-search' data-controls='chiselchat-user-search-controls' placeholder='Search'>\n</form><ul id='chiselchat-user-search'></ul>\n</div>\n</div>\n<div id='chiselchat-room-pane' class='chiselchat-tab-pane'>\n<div class=\"chiselchat-title\">\nRooms\n<span class=\"chiselchat-pane-controls\">\n<a href='javascript: void(0);' data-event='chiselchat-minimize-pane' class='chiselchat-minimize-pane' title='Minimize'>&UnderBar;</a>\n<a href='javascript: void(0);' data-event='chiselchat-toggle-pane-size' class='chiselchat-toggle-pane-size' title='Toggle Chat Window Size'>&uhblk;</a>\n</span>\n</div><div class=\"chiselchat-scrollable-list\">\n<form id='chiselchat-create-room'>\n<input id='chiselchat-input-room-name' data-input='chiselchat-room-name' type='text' placeholder='Create new room...' maxlength='"+__e(maxLengthRoomName)+"'>\n</form>\n<ul id='chiselchat-room-list'></ul>\n</div>\n</div>\n</div><div id='chiselchat-footer' class='clearfix'></div>\n</div>";return __p},this.ChiselchatDefaultTemplates["templates/layout-popout.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+="<div id='chiselchat' class='full'>\n<div id='chiselchat-tabs' class='clearfix'>\n<ul id='chiselchat-tab-list' class='nav nav-tabs clearfix'></ul>\n<div id='chiselchat-tab-content' class='tab-content'></div>\n</div>\n</div>";return __p},this.ChiselchatDefaultTemplates["templates/message.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(Array.prototype.join,obj)__p+="<div class='chiselchat-message chiselchat-message-"+__e(type)+" ",isSelfMessage&&(__p+=" chiselchat-message-self "),__p+="' data-message-id='"+__e(id)+"' data-user-id='"+__e(userId)+"' data-user-name='"+__e(name)+"' data-class=\"chiselchat-message\">\n<div class='chiselchat-avatar'>\n<a href='javascript: void(0)'><img src='/chiselchat/guest_logo.png'></a>\n<div class='chiselchat-timestamp'>"+__e(localtime)+"</div>\n</div>\n<div class='chiselchat-user'><a href='javascript: void(0)'>"+__e(name)+"</a>\n&nbsp;\n<span class='chiselchat-controls'>\n",disableActions||(__p+="\n<a href='javascript: void(0);' data-event='chiselchat-user-chat' title='Invite to Private Chat'>PM</a>\n<a href='javascript: void(0);' data-event='chiselchat-user-mute-toggle' title='Mute User'>Mute</a>\n",userIsModerator&&(__p+="\n<a href='javascript: void(0);' data-event='chiselchat-user-warn'>Warn</a>\n<a href='javascript: void(0);' data-event='chiselchat-user-suspend-hour'>Ban (hour)</a>\n<a href='javascript: void(0);' data-event='chiselchat-user-suspend-day'>Ban (day)</a>\n"),__p+="\n"),__p+="\n</span>\n</div>\n<div class='chiselchat-message-content'>\n"+(null==(__t=message)?"":__t)+"\n",userIsModerator&&(__p+="\n<span class='chiselchat-controls'>&nbsp;<a href='javascript: void(0);' data-event='chiselchat-message-delete' title='Delete This Message'>&times;</a>\n"),__p+="\n</div>\n</div>";return __p},this.ChiselchatDefaultTemplates["templates/room-list-item.html"]=function(obj){obj||(obj={});var __p="",__e=_.escape;with(Array.prototype.join,obj)__p+="<li data-room-type='"+__e(type)+"' data-room-id='"+__e(id)+"' data-room-name='"+__e(name)+"'>\n<a href='javascript: void(0);' class='chiselchat-room-list-item ",isRoomOpen&&(__p+=" highlight "),__p+="'>\n<span title='"+__e(name)+"'>"+__e(name)+"</span>\n</a>\n","official"!=type&&(__p+="\n",userIsModerator&&(__p+="\n<a href='javascript: void(0);' class='chiselchat-delete-room' title='Remove Room'>&times;</a>\n"),__p+="\n"),__p+="\n</li>";return __p},this.ChiselchatDefaultTemplates["templates/room-user-list-item.html"]=function(obj){obj||(obj={});var __p="",__e=_.escape;with(Array.prototype.join,obj)__p+="<li data-user-id='"+__e(id)+"' data-user-name='"+__e(name)+"'>\n<a href='javascript: void(0);'>\n<span class='' title='"+__e(name)+"'>"+__e(name)+"</span>\n</a>\n",disableActions||(__p+="\n<span class='chiselchat-controls'>\n<a href='javascript: void(0);'><span data-event='chiselchat-user-mute-toggle' class='",isMuted&&(__p+=" chiselchat-muted "),__p+="' title='Toggle User Mute'>",__p+=isMuted?"Unmute":"Mute",__p+="</span></a>\n<a href='javascript: void(0);'><span data-event='chiselchat-user-chat' title='Invite to Private Chat'>PM</span></a>\n</span>\n"),__p+="\n</li>";return __p},this.ChiselchatDefaultTemplates["templates/room-user-search-list-item.html"]=function(obj){obj||(obj={});var __p="",__e=_.escape;with(Array.prototype.join,obj)__p+="<li data-user-id='"+__e(id)+"' data-user-name='"+__e(name)+"'>\n<a href='javascript: void(0);' class='clearfix'>\n",__p+=disableActions?"\n<span class='left fourfifth clipped' title='"+__e(name)+"'>"+__e(name)+"</span>\n":"\n<span data-event='chiselchat-user-invite' class='left fourfifth clipped' title='"+__e(name)+"'>"+__e(name)+"</span>\n<span data-event='chiselchat-user-invite' class='icon plus right' title='Invite to Room'>+</span>\n",__p+="\n</a>\n</li>";return __p},this.ChiselchatDefaultTemplates["templates/tab-content.html"]=function(obj){obj||(obj={});var __p="",__e=_.escape;with(obj)__p+="<div id='"+__e(id)+"' data-room-id='"+__e(id)+'\' class=\'chiselchat-tab-pane\'>\n<div class="chiselchat-title">\n<span class="chiselchat-title-text">'+__e(name)+"</span>\n<span class=\"chiselchat-pane-controls\">\n<a href='javascript: void(0);' data-event='chiselchat-minimize-pane' class='chiselchat-minimize-pane' title='Minimize'>&UnderBar;</a>\n<a href='javascript: void(0);' data-event='chiselchat-toggle-pane-size' class='chiselchat-toggle-pane-size' title='Toggle Chat Window Size'>&uhblk;</a>\n<a href='javascript: void(0);' data-event='chiselchat-close-tab' class='chiselchat-close-tab' title='Leave Room'>&times;</a>\n</span>\n</div>\n<div class='chiselchat-tab-pane-menu'>\n<div class='chiselchat-scrollable-list'>\n<button data-event='chiselchat-user-room-list-btn' href='javascript: void(0);' data-target='chiselchat-room-user-list-"+__e(id)+"'>\nPeople In Room\n</button>\n<ul id='chiselchat-room-user-list-"+__e(id)+"'></ul><div>\n<b>Invite</b>\n<input type='text' data-event='chiselchat-user-search' data-template='templates/room-user-search-list-item.html' data-target='chiselchat-room-user-search-"+__e(id)+"' data-controls='chiselchat-room-user-search-controls-"+__e(id)+"'>\n<div class=\"chiselchat-scrollable-list\">\n<ul id='chiselchat-room-user-search-"+__e(id)+"'></ul>\n</div>\n</div>\n</div>\n</div><div id='chiselchat-messages"+__e(id)+"' class='chiselchat-history'></div><div class='chiselchat-say'>\n<textarea id='textarea"+__e(id)+"' placeholder='Type your message here...'></textarea>\n</div>\n</div>";return __p},this.ChiselchatDefaultTemplates["templates/tab-menu-item.html"]=function(obj){obj||(obj={});var __p="",__e=_.escape;with(obj)__p+="<li data-room-id='"+__e(id)+"'>\n<a href='#"+__e(id)+"' data-toggle='tab' title='"+__e(name)+"'><span class='chiselchat-tab-text'>"+__e(name)+"</span> <span class='chiselchat-new-count'>0</span></a>\n</li>";return __p},this.ChiselchatDefaultTemplates["templates/user-search-list-item.html"]=function(obj){obj||(obj={});var __p="",__e=_.escape;with(Array.prototype.join,obj)__p+="<li data-user-id='"+__e(id)+"' data-user-name='"+__e(name)+"'>\n<a href='javascript: void(0);'>\n",__p+=disableActions?"\n<span title='"+__e(name)+"'>"+__e(name)+"</span>\n":"\n<span data-event='chiselchat-user-chat' title='"+__e(name)+"'>"+__e(name)+"</span>\n<span data-event='chiselchat-user-chat' title='Invite to Private Chat'>+</span>\n",__p+="\n</a>\n</li>";return __p},function(){Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,a=function(){},i=function(){return n.apply(this instanceof a&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return a.prototype=this.prototype,i.prototype=new a,i}),Object.keys=Object.keys||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t}}(),function(e){function t(e,t){this._firebase=e,this._user=null,this._userId=null,this._userName=null,this._isModerator=!1,this._sessionId=null,this._events={},this._rooms={},this._presenceBits={},this._userRef=null,this._messageRef=this._firebase.child("room-messages"),this._roomRef=this._firebase.child("room-metadata"),this._privateRoomRef=this._firebase.child("room-private-metadata"),this._moderatorsRef=this._firebase.child("moderators"),this._suspensionsRef=this._firebase.child("suspensions"),this._usersOnlineRef=this._firebase.child("user-names-online"),this._options=t||{},this._chatter_cache={},this._options.numMaxMessages=this._options.numMaxMessages||50}var n=this,a=n.Chiselchat;t.noConflict=function(){return n.Chiselchat=a,t},n.Chiselchat=t,t.prototype={_loadUserMetadata:function(e){var t=this;this._userRef.transaction(function(e){var n={id:t._userId,name:t._userName,avatarUri:t._avatarUri,profileUri:t._profileUri,isModerator:t._isModerator};return e&&(e.rooms&&(n.rooms=e.rooms),e.sessions&&(n.sessions=e.sessions),e.muted&&(n.muted=e.muted)),n},function(a,i,r){t._user=r.val(),t._chatter_cache[t._user.id]=t._user,t._moderatorsRef.child(t._userId).once("value",function(a){t._isModerator=!!a.val(),n.setTimeout(e,0)})})},_setupDataEvents:function(){this._firebase.root().child(".info/connected").on("value",function(e){if(e.val()===!0)for(var t=0;this._presenceBits>t;t++){var n=this._presenceBits[t],a=this._firebase.root().child(n.ref);a.onDisconnect().set(n.offlineValue),a.set(n.onlineValue)}},this);var e=this._userRef.child("sessions").push();this._sessionId=e.name(),this._queuePresenceOperation(e,!0,null);var t=this._usersOnlineRef.child(this._userName.toLowerCase()),n=t.child(this._sessionId);this._queuePresenceOperation(n,{id:this._userId,name:this._userName},null),this._userRef.on("value",this._onUpdateUser,this),this._userRef.child("invites").on("child_added",this._onChiselchatInvite,this),this._userRef.child("notifications").on("child_added",this._onNotification,this);var a=this;this._roomRef.on("child_removed",function(e){a.leaveRoom(e.name())}),this._roomRef.startAt(Date.now()).on("child_added",function(e){this._onCreateRoom(e)},this),a._roomRef.on("child_changed",function(e){a._invokeEventCallbacks("room-changed",e.val())})},_addEventCallback:function(e,t){this._events[e]=this._events[e]||[],this._events[e].push(t)},_getEventCallbacks:function(e){return this._events.hasOwnProperty(e)?this._events[e]:[]},_invokeEventCallbacks:function(e){var t=[],n=this._getEventCallbacks(e);Array.prototype.push.apply(t,arguments),t=t.slice(1);for(var a=0;n.length>a;a+=1)n[a].apply(null,t)},_queuePresenceOperation:function(e,t,n){e.onDisconnect().set(n),e.set(t),this._presenceBits[""+e]={ref:e,onlineValue:t,offlineValue:n}},_removePresenceOperation:function(t,n){var a=new e(t);a.onDisconnect().cancel(),a.set(n),delete this._presenceBits[t]},_onUpdateUser:function(e){this._user=e.val(),this._invokeEventCallbacks("user-update",this._user)},_onCreateRoom:function(e){var t=e.val();this._invokeEventCallbacks("room-create",t)},_onAuthRequired:function(){this._invokeEventCallbacks("auth-required")},_onEnterRoom:function(e){this._invokeEventCallbacks("room-enter",e)},_onNewMessage:function(e,t){var n=t.val();n.id=t.name(),this._invokeEventCallbacks("message-add",e,n)},_onRemoveMessage:function(e,t){var n=t.name();this._invokeEventCallbacks("message-remove",e,n)},_onLeaveRoom:function(e){this._invokeEventCallbacks("room-exit",e)},_onNotification:function(e){var t=e.val();t.read?e.ref().remove():(e.ref().child("read").set(!0),this._invokeEventCallbacks("notification",t))},_onChiselchatInvite:function(e){var t=this,n=e.val();n.status||(n.id=n.id||e.name(),t.getRoom(n.roomId,function(e){n.toRoomName=e.name,t._invokeEventCallbacks("room-invite",n)}))},_onChiselchatInviteResponse:function(e){var t=e.val();t.id=t.id||e.name(),this._invokeEventCallbacks("room-invite-response",t)}},t.prototype.setUser=function(e,t){var a=this;a._firebase.root().child(".info/authenticated").on("value",function(i){i.val()===!0&&(a._firebase.root().child(".info/authenticated").off(),a._userId=""+e.userId,a._userName=""+e.userName,a._isModerator=e.isModerator,a._avatarUri=""+e.avatarUri,a._profileUri=""+e.profileUri,a._isModerator===!0&&(a._moderatorsRef.child(a._userId).set(!0),a._moderatorsRef.child(a._userId).onDisconnect().remove()),a._userRef=a._firebase.child("users").child(a._userId),a._loadUserMetadata(function(){n.setTimeout(function(){t(a._user),a._setupDataEvents()},0)}))})},t.prototype.lookupUser=function(e,t){var n=this;e in n._chatter_cache?t(this._chatter_cache[e]):n._firebase.child("users").child(e).once("value",function(a){var i=a.val();n._chatter_cache[e]=i,t(i)})},t.prototype.resumeSession=function(){this._userRef.child("rooms").once("value",function(e){var t=e.val();for(var n in t)this.enterRoom(t[n].id)},function(){},this),this._roomRef.once("value",function(e){var t=e.val();for(var n in t)"official"==t[n].type&&this.enterRoom(n)},function(){},this)},t.prototype.on=function(e,t){this._addEventCallback(e,t)},t.prototype.createRoom=function(t,n,a){var i=this,r=this._roomRef.push(),s={id:r.name(),name:t,type:n||"public",createdByUserId:this._userId,".priority":e.ServerValue.TIMESTAMP};"private"===n&&(s.authorizedUsers={},s.authorizedUsers[this._userId]=!0),r.set(s,function(e){e||i.enterRoom(r.name()),a&&a(r.name())})},t.prototype.enterRoom=function(e){var t=this;t.getRoom(e,function(n){var a=n.name;if(e&&a&&!t._rooms[e]){if(t._rooms[e]=!0,t._user){t._userRef.child("rooms").child(e).set({id:e,name:a,active:!0});var i=t._firebase.child("room-users").child(e).child(t._userId).child(t._sessionId);t._queuePresenceOperation(i,{id:t._userId,name:t._userName},null)}t._onEnterRoom({id:e,name:a}),t._roomRef.child(e).once("value",function(){t._messageRef.child(e).limit(t._options.numMaxMessages).on("child_added",function(n){t._onNewMessage(e,n)},function(){t.leaveRoom(e)},t),t._messageRef.child(e).limit(t._options.numMaxMessages).on("child_removed",function(n){t._onRemoveMessage(e,n)},function(){},t)},function(){},t)}})},t.prototype.leaveRoom=function(e){var t=this,n=t._firebase.child("room-users").child(e);if(t._messageRef.child(e).off(),t._user){var a=n.child(t._userId).child(t._sessionId);t._removePresenceOperation(""+a,null),t._userRef.child("rooms").child(e).remove()}delete t._rooms[e],t._onLeaveRoom(e)},t.prototype.removeRoom=function(e){var t=this;t.leaveRoom(e),t._firebase.child("users").once("value",function(n){var a=n.val();for(var i in a)t._firebase.child("users").child(i).child(e).remove()}),t._messageRef.child(e).remove(),t._firebase.child("room-users").child(e).remove(),t._roomRef.child(e).remove()},t.prototype.sendMessage=function(t,n,a,i){var r,s=this,o={userId:s._userId,name:s._userName,timestamp:e.ServerValue.TIMESTAMP,message:n,type:a||"default"};return s._user?(r=s._messageRef.child(t).push(),r.setWithPriority(o,e.ServerValue.TIMESTAMP,i),void 0):(s._onAuthRequired(),i&&i(Error("Not authenticated or user not set!")),void 0)},t.prototype.deleteMessage=function(e,t,n){var a=this;a._messageRef.child(e).child(t).remove(n)},t.prototype.toggleUserMute=function(e,t){var n=this;return n._user?(n._firebase.child("users").child(e).once("value",function(a){a.val().isModerator?t(Error("Cannot mute a moderator.")):n._userRef.child("muted").child(e).transaction(function(e){return e?null:!0},t)}),void 0):(n._onAuthRequired(),t&&t(Error("Not authenticated or user not set!")),void 0)},t.prototype.sendSuperuserNotification=function(t,n,a,i){var r=this,s=r._firebase.child("users").child(t).child("notifications");s.push({fromUserId:r._userId,timestamp:e.ServerValue.TIMESTAMP,notificationType:n,data:a||{}},i)},t.prototype.warnUser=function(e){var t=this;t.sendSuperuserNotification(e,"warning")},t.prototype.suspendUser=function(e,t,n){var a=this,i=(new Date).getTime()+1e3*t;a._suspensionsRef.child(e).set(i,function(t){return t&&n?n(t):(a.sendSuperuserNotification(e,"suspension",{suspendedUntil:i}),n(null))})},t.prototype.inviteUser=function(e,t){var n=this,a=function(){var a=n._firebase.child("users").child(e).child("invites").push();a.set({id:a.name(),fromUserId:n._userId,fromUserName:n._userName,roomId:t}),a.on("value",n._onChiselchatInviteResponse,function(){},n)};return n._user?(n.getRoom(t,function(i){if("private"===i.type){var r=n._roomRef.child(t).child("authorizedUsers");r.child(e).set(!0,function(e){e||a()})}else a()}),void 0):(n._onAuthRequired(),void 0)},t.prototype.acceptInvite=function(e,t){var n=this;n._userRef.child("invites").child(e).once("value",function(a){var i=a.val();return null===i&&t?t(Error("acceptInvite("+e+"): invalid invite id")):(n.enterRoom(i.roomId),n._userRef.child("invites").child(e).update({status:"accepted",toUserName:n._userName},t(i)),void 0)},n)},t.prototype.declineInvite=function(e,t){var n=this,a={status:"declined",toUserName:n._userName};n._userRef.child("invites").child(e).update(a,t)},t.prototype.getRoomList=function(e){var t=this;t._roomRef.once("value",function(t){e(t.val())})},t.prototype.getUserNameById=function(e,t){var n=this;n._firebase.child("users").child(e+"/name").once("value",t)},t.prototype.getUsersByRoom=function(){var e=this,t=arguments[0],a=e._firebase.child("room-users").child(t),i=arguments[arguments.length-1],r=null;arguments.length>2&&(r=arguments[1]),a=r?a.limit(r):a,a.once("value",function(e){var t=e.val()||{},a={};
for(var r in t)for(var s in t[r]){a[r]=t[r][s];break}n.setTimeout(function(){i(a)},0)})},t.prototype.getUsersByPrefix=function(e,t,a,i,r){var s=this._usersOnlineRef,o=e.toLowerCase();s=t?s.startAt(null,t):a?s.endAt(null,a):o?s.startAt(null,o):s.startAt(),s=i?s.limit(i):s,s.once("value",function(t){var a=t.val()||{},i={};for(var s in a){var c,l,u=a[s];for(var h in u){c=u[h].name,l=u[h].id;break}e.length>0&&0!==c.toLowerCase().indexOf(o)||(i[c]={name:c,id:l})}n.setTimeout(function(){r(i)},0)})},t.prototype.getRoom=function(e,t){this._roomRef.child(e).once("value",function(e){t(e.val())})},t.prototype.userIsModerator=function(){return this._isModerator}}(Firebase),function(e){function t(t,n,a){if(!t)throw Error("ChiselchatUI: Missing required argument `firebaseRef`");if(!n)throw Error("ChiselchatUI: Missing required argument `el`");a=a||{},this._options=a,this._el=n,this._user=null,this._chat=new Chiselchat(t,a),this._roomQueue=[],this.autoFocusTab=!1,this.fullScreenTab=!1,this.commands=[],this.maxLengthUsername=15,this.maxLengthUsernameDisplay=15,this.maxLengthRoomName=16,this.maxLengthMessage=1e3,this.maxUserSearchResults=100,this.urlPattern=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim,this.pseudoUrlPattern=/(^|[^\/])(www\.[\S]+(\b|$))/gim,this._renderLayout(),this.$wrapper=e("#chiselchat"),this.$roomList=e("#chiselchat-room-list"),this.$tabList=e("#chiselchat-tab-list"),this.$tabContent=e("#chiselchat-tab-content"),this.$messages={},this.$rateLimit={limitCount:10,limitInterval:1e4,limitWaitTime:3e4,history:{}},this._bindUIEvents(),this._bindDataEvents(),this._initCommands()}if(!e||170>parseInt(e().jquery.replace(/\./g,""),10))throw Error("jQuery 1.7 or later required!");var n=this,a=n.ChiselchatUI;if(n.ChiselchatUI=t,!self.ChiselchatDefaultTemplates)throw Error("Unable to find chat templates!");t.noConflict=function(){return n.ChiselchatUI=a,t},t.prototype={_initCommands:function(){self=this,self.addCommand({match:/^\/help$/,func:function(e,t){var n="";for(var a in t.commands)(!t.commands[a].moderatorOnly||t._chat.userIsModerator())&&(n+="<p><b>"+t.commands[a].name+"</b> - "+t.commands[a].help+"</p>");t.info(n,"Chat Help"),e.type="command"},name:"/help",help:"Display this message."}),self.addCommand({match:/^\/me\s/,func:function(e){e.content=e.content.replace(/^\/me/,""),e.type="activity"},name:"/me <message>",help:"Your name will appear followed by any text you write."}),self.addCommand({match:/^\/leave$/,func:function(e,t){t._chat.leaveRoom(e.roomId),e.type="command"},name:"/leave",help:"Leave the current room."}),self.addCommand({match:/^\/topic\s/,func:function(e,t){var n=e.content.replace(/^\/topic\s+/,"");if(e.content.match(/\w+/)){var a=t._chat._roomRef.child(e.roomId);a.transaction(function(i){"official"==i.type?t.error("Cannot modify the topic of an official room."):(a.child("name").set(n),t._chat.sendMessage(e.roomId,'changed the topic to "'+n+'".',"activity"))})}e.type="command"},name:"/topic <new topic name>",help:"Change the name of the room.",moderatorOnly:!0})},_bindUIEvents:function(){this._bindForRoomList(),this._bindForUserRoomList(),this._bindForUserSearch(),this._bindForUserMuting(),this._bindForChatInvites(),this._bindForRoomListing(),this._bindForRoomNotification(),this._setupTabs(),this._bindTextInputFieldLimits()},_bindDataEvents:function(){this._chat.on("user-update",this._onUpdateUser.bind(this)),this._chat.on("room-enter",this._onEnterRoom.bind(this)),this._chat.on("room-create",this._onCreateRoom.bind(this)),this._chat.on("room-changed",this._onRoomChanged.bind(this)),this._chat.on("room-exit",this._onLeaveRoom.bind(this)),this._chat.on("message-add",this._onNewMessage.bind(this)),this._chat.on("message-remove",this._onRemoveMessage.bind(this)),this._chat.on("room-invite",this._onChatInvite.bind(this)),this._chat.on("room-invite-response",this._onChatInviteResponse.bind(this)),this._chat.on("notification",this._onNotification.bind(this))},_renderLayout:function(){var t=ChiselchatDefaultTemplates["templates/layout-full.html"];e(this._el).html(t({maxLengthUsername:this.maxLengthUsername,maxLengthRoomName:this.maxLengthRoomName,isModerator:this._chat.userIsModerator()}))},_onUpdateUser:function(t){this._user=t;var n=this._user.muted||{};e('[data-event="chiselchat-user-mute-toggle"]').each(function(){var t=e(this).closest("[data-user-id]").data("user-id");e(this).toggleClass("chiselchat-muted",!!n[t])});for(var a in n)e('.message[data-user-id="'+a+'"]').fadeOut()},_onEnterRoom:function(e){this.attachTab(e.id,e.name)},_onRoomChanged:function(t){e('#chiselchat-tab-list li[data-room-id="'+t.id+'"] a .chiselchat-tab-text').html(t.name),e('[data-room-id="'+t.id+'"] .chiselchat-title-text').html(t.name)},_onCreateRoom:function(e){self=this,"public"==e.type&&self.info('A new public chatroom called "<a href="javascript: void(0)" data-event="chiselchat-room-notification" data-room-id="'+e.id+'" data-room-name="'+e.name+'">'+e.name+'</a>" has been created.')},_onLeaveRoom:function(e){this.removeTab(e),this._roomQueue.length>0&&this._chat.enterRoom(this._roomQueue.shift(e))},_onNewMessage:function(t,n){var a=n.userId,i=this;this._user&&this._user.muted&&this._user.muted[a]||(i.showMessage(t,n),this._chat.lookupUser(a,function(t){var a=e('div[data-message-id="'+n.id+'"]');t.profileUri&&(a.find(".chiselchat-avatar > a").attr("href",t.profileUri),a.find(".chiselchat-user > a").attr("href",t.profileUri)),t.avatarUri&&a.find(".chiselchat-avatar img").attr("src",t.avatarUri),t.isModerator&&a.find(".chiselchat-user > a").addClass("chiselchat-moderator")}))},_onRemoveMessage:function(e,t){this.removeMessage(e,t)},_onChatInvite:function(e){var t=this;t.confirm(e.fromUserName+" invited you to join "+e.toRoomName,"Invitation",function(){return t._chat.acceptInvite(e.id,function(e){e instanceof Error||t.focusTab(e.roomId)}),!1},function(){return t._chat.declineInvite(e.id),!1})},_onChatInviteResponse:function(t){if(t.status){var n=this;t.status&&"accepted"===t.status?(n.success(t.toUserName+" accepted your invite.","Invitation Accepted"),this._chat.getRoom(t.roomId,function(a){var i=e('#chiselchat-tab-list li[data-room-id="'+t.roomId+'"]');i.length||(n.autoFocusTab=!0,n.attachTab(t.roomId,a.name))})):n.error(t.toUserName+" declined your invite.","Invitation Declined")}},_onNotification:function(e){if("warning"===e.notificationType)this.warn("You are being warned for inappropriate messaging. Further violation may result in temporary or permanent ban of service.");else if("suspension"===e.notificationType){var t=e.data.suspendedUntil,n=Math.round((t-(new Date).getTime())/1e3),a="";if(n>0){if(n>7200){var i=Math.floor(n/3600);a=i+" hours, ",n-=3600*i}a+=Math.floor(n/60)+" minutes",this.error("A moderator has suspended you for violating site rules. You cannot send messages for another "+a+".","Suspended")}}}},t.prototype.setUser=function(e){var t=this;t._chat.setUser(e,function(e){t._user=e,t._chat.userIsModerator()&&t._bindSuperuserUIEvents(),t._chat.resumeSession()})},t.prototype.on=function(e,t){this._chat.on(e,t)},t.prototype._bindSuperuserUIEvents=function(){var t=this,n=function(){var t=e(this),n=t.closest("[data-message-id]").data("message-id"),a=e('[data-message-id="'+n+'"]').closest("[data-user-id]").data("user-id"),i=e('[data-message-id="'+n+'"]').closest("[data-room-id]").data("room-id");return{messageId:n,userId:a,roomId:i}};e(document).delegate('[data-event="chiselchat-user-warn"]',"click",function(e){var a=n.call(this,e);t._chat.warnUser(a.userId),t._chat.getUserNameById(a.userId,function(e){t._chat.sendMessage(a.roomId,"warned "+e.val()+".","activity")})}),e(document).delegate('[data-event="chiselchat-user-suspend-hour"]',"click",function(e){var a=n.call(this,e);t._chat.suspendUser(a.userId,3600),t._chat.getUserNameById(a.userId,function(e){t._chat.sendMessage(a.roomId,"suspended "+e.val()+" for 1 hour.","activity")})}),e(document).delegate('[data-event="chiselchat-user-suspend-day"]',"click",function(e){var a=n.call(this,e);t._chat.suspendUser(a.userId,86400),t._chat.getUserNameById(a.userId,function(e){t._chat.sendMessage(a.roomId,"suspended "+e.val()+" for 1 day.","activity")})}),e(document).delegate('[data-event="chiselchat-message-delete"]',"click",function(e){var a=n.call(this,e);t._chat.deleteMessage(a.roomId,a.messageId)})},t.prototype._bindForRoomList=function(){var t=this;e("#chiselchat-room-tab").bind("click",function(){var n=(e(this),ChiselchatDefaultTemplates["templates/room-list-item.html"]),a=function(){var n=e(this).parent(),a=n.data("room-id"),i=n.data("room-name");return t.$messages[a]?t.focusTab(a):(t.autoFocusTab=!0,t._chat.enterRoom(a,i)),!1};deleteRoom=function(){var n=e(this).parent(),a=n.data("room-id");t._chat.removeRoom(a),n.remove()},t._chat.getRoomList(function(i){t.$roomList.empty();for(var r in i){var s=i[r];if("private"!=s.type){s.isRoomOpen=!!t.$messages[s.id],s.userIsModerator=t._chat.userIsModerator();var o=e(n(s));o.children(".chiselchat-room-list-item").bind("click",a),o.children(".chiselchat-delete-room").bind("click",deleteRoom),t.$roomList.append(o.toggle(!0))}}})})},t.prototype._bindForUserRoomList=function(){var t=this;e(document).delegate('[data-event="chiselchat-user-room-list-btn"]',"click",function(n){n.stopPropagation();var a=e(this),i=a.closest("[data-room-id]").data("room-id"),r=ChiselchatDefaultTemplates["templates/room-user-list-item.html"],s=a.data("target"),o=e("#"+s);o.empty(),t._chat.getUsersByRoom(i,function(n){for(var a in n)user=n[a],user.disableActions=!t._user||user.id===t._user.id,user.nameTrimmed=t.trimWithEllipsis(user.name,t.maxLengthUsernameDisplay),user.isMuted=t._user&&t._user.muted&&t._user.muted[user.id],o.append(e(r(user)));t.sortListLexicographically("#"+s)})})},t.prototype._bindForUserSearch=function(){var t=this,n=function(t){var n=e(this),i=n.data("target"),r=n.data("controls"),s=n.data("template"),o=n.val()||n.data("prefix")||"",c=n.data("startAt")||null,l=n.data("endAt")||null;t.preventDefault(),a(i,s,r,o,c,l)},a=function(n,a,i,r,s,o){var c=e("#"+n),l=ChiselchatDefaultTemplates[a];t._chat.getUsersByPrefix(r,s,o,t.maxUserSearchResults,function(e){var n,a,i,r=0;c.empty();for(n in e){var s=e[n];if(s.disableActions=!t._user||s.id===t._user.id,r+=1,c.append(l(s)),1===r)a=s.name.toLowerCase();else if(r>=t.maxUserSearchResults){i=s.name.toLowerCase();break}}})};e(document).delegate('[data-event="chiselchat-user-search"]',"keyup",n),e(document).delegate('[data-event="chiselchat-user-search"]',"click",n),e(document).delegate("#chiselchat-user-search-form","submit",n),e(document).delegate("#chiselchat-presence-tab","click",function(t){t.stopPropagation();var n=e("#chiselchat-user-search-form").find("input");n.focus(),n.trigger(jQuery.Event("keyup"))})},t.prototype._bindForUserMuting=function(){var t=this;e(document).delegate('[data-event="chiselchat-user-mute-toggle"]',"click",function(n){var a=e(this),i=a.closest("[data-user-id]").data("user-id"),r=a.closest("[data-user-name]").data("user-name"),s=a.hasClass("chiselchat-muted");n.preventDefault(),t._chat.toggleUserMute(i,function(e){e?t.error(e.message):s?(t.success(r+" has been unmuted.","User Unmuted"),a.html("Mute")):(t.error(r+" has been muted.","User Muted"),a.html("Unmute"))})})},t.prototype._bindForChatInvites=function(){var t=this,n=function(){var n=e(this),a=n.closest("[data-user-id]").data("user-id"),i=n.closest("[data-room-id]").data("room-id"),r=n.closest("[data-user-name]").data("user-name");return t._chat.getRoom(i,function(e){t._chat.inviteUser(a,i,e.name),t.info(r+" invited.")}),!1},a=function(){var n=e(this),a=n.closest("[data-user-id]").data("user-id"),i=n.closest("[data-user-name]").data("user-name");if(a&&i){var r="Private Chat";t.autoFocusTab=!0,t._chat.createRoom(r,"private",function(e){t._chat.inviteUser(a,e,r),t.info(i+" invited.")})}return!1};e(document).delegate('[data-event="chiselchat-user-chat"]',"click",a),e(document).delegate('[data-event="chiselchat-user-invite"]',"click",n)},t.prototype._bindForRoomNotification=function(){var t=this,n=function(){var n=e(this),a=n.data("room-id"),i=n.data("room-name");return t.autoFocusTab=!0,t._chat.enterRoom(a,i),!1};e(document).delegate('[data-event="chiselchat-room-notification"]',"click",n)},t.prototype._bindForRoomListing=function(){var t=this;e("#chiselchat-create-room").bind("submit",function(){var n=e("#chiselchat-input-room-name").val();return e("#chiselchat-input-room-name").val(""),n.length?(t.autoFocusTab=!0,t._chat.createRoom(n)):t.error("Room name must be specified."),!1})},t.prototype._setupTabs=function(){var t=this,n=function(n){n.parent("li").removeClass("active"),e("#chiselchat-tab-content .chiselchat-tab-pane").removeClass("active"),t.resetNewMessageCount(n.parent("li").attr("data-room-id"))},a=function(n){var a,r,s=n,o=s.closest("ul"),c=s.attr("data-target"),l=o.find(".active:last a")[0];c||(c=s.attr("href"),c=c&&c.replace(/.*(?=#[^\s]*$)/,"")),t.resetNewMessageCount(e(l).parent("li").attr("data-room-id")),s.parent("li").hasClass("active")||(r=e.Event("show",{relatedTarget:l}),s.trigger(r),r.isDefaultPrevented()||(a=e(c),i(s.parent("li"),o),i(a,a.parent(),function(){s.trigger({type:"shown",relatedTarget:l})}),a.find(".chiselchat-history").css("height",a.height()-75+"px")))},i=function(e,n,a){var i=n.find("> .active");i.removeClass("active").removeClass("fullscreen"),e.addClass("active"),t.fullScreenTab&&e.addClass("fullscreen"),a&&a()};e(document).delegate('[data-toggle="tab"]',"click",function(t){t.preventDefault();var i=e(this);i.parent("li").hasClass("active")?n(i):a(i)}),e(document).delegate('[data-event="chiselchat-minimize-pane"]',"click",function(){var t=e(this).closest("[data-room-id]").data("room-id");return n(e('#chiselchat-tab-list li[data-room-id="'+t+'"] a, #chiselchat-room-tab a, #chiselchat-presence-tab a')),!1}),e(document).delegate('[data-event="chiselchat-close-tab"]',"click",function(){var n=e(this).closest("[data-room-id]").data("room-id");return t._chat.leaveRoom(n),!1}),e(document).delegate('[data-event="chiselchat-toggle-pane-size"]',"click",function(){return t.fullScreenTab?(t.fullScreenTab=!1,e(this).closest(".chiselchat-tab-pane").removeClass("fullscreen")):(e(this).closest(".chiselchat-tab-pane").addClass("fullscreen"),t.fullScreenTab=!0),e(window).trigger("resize"),!1})},t.prototype._bindTextInputFieldLimits=function(){e("body").delegate('input[data-provide="limit"], textarea[data-provide="limit"]',"keyup",function(){var t=e(this),n=e(t.data("counter")),a=t.attr("maxlength"),i=t.val().length;n.html(Math.max(0,a-i))})},t.prototype.confirm=function(e,t,n,a){new PNotify({title:t||"Confirmation Needed",text:e,addclass:"alert-info",type:"info",icon:"glyphicon glyphicon-question-sign",hide:!1,confirm:{confirm:!0},buttons:{closer:!1,sticker:!1},history:{history:!1}}).get().on("pnotify.confirm",function(){n()}).on("pnotify.cancel",function(){a()})},t.prototype.warn=function(e,t){new PNotify({addclass:"alert-warning",title:t||"Warning",text:e,icon:"glyphicon glyphicon-exclamation-sign",opacity:.95,history:!1,sticker:!1})},t.prototype.info=function(e,t){new PNotify({addclass:"alert-info",type:"info",title:t||"Info",text:e,icon:"glyphicon glyphicon-info-sign",opacity:.95,history:!1,sticker:!1})},t.prototype.error=function(e,t){new PNotify({addclass:"alert-danger",type:"error",title:t||"Error",text:e,icon:"glyphicon glyphicon-warning-sign",opacity:.95,history:!1,sticker:!1})},t.prototype.success=function(e,t){new PNotify({addclass:"alert-success",type:"success",title:t||"Success",text:e,icon:"glyphicon glyphicon-ok-sign",opacity:.95,history:!1,sticker:!1})},t.prototype.addCommand=function(e){self=this,self.commands.push(e)},t.prototype.executeCommands=function(e){var t=this;for(var n in t.commands){var a=t.commands[n];if(e.content.match(a.match)){if(a.moderatorOnly&&!t._chat.userIsModerator())continue;a.func(e,t)}}},t.prototype.resetNewMessageCount=function(e){var t=this.$tabList.find("[data-room-id="+e+"]").find("a");t.length&&t.first().children(".chiselchat-new-count").html("0")},t.prototype.toggleInputs=function(t){e("#chiselchat-tab-content textarea").each(function(){var n=e(this);t?e(this).val(""):e(this).val("You have exceeded the message limit, please wait before sending."),n.prop("disabled",!t)}),e("#chiselchat-input-name").prop("disabled",!t)},t.prototype.attachTab=function(t,n){var a=this;if(this.$messages[t])return this.focusTab(t),void 0;var i={id:t,name:n},r=ChiselchatDefaultTemplates["templates/tab-content.html"],s=e(r(i));this.$tabContent.prepend(s);var o=e("#chiselchat-messages"+t);this.$messages[t]=o;var c=s.find("textarea").first();c.bind("keydown",function(e){var n={content:a.trimWithEllipsis(c.val(),a.maxLengthMessage),type:"default",roomId:t};return 13===e.which&&""!==n.content?(c.val(""),a.executeCommands(n),("activity"==n.type||"default"==n.type)&&a._chat.sendMessage(n.roomId,n.content,n.type,function(e){e&&a.error("You are not allowed to post messages right now.")}),!1):void 0});var l=ChiselchatDefaultTemplates["templates/tab-menu-item.html"],u=e(l(i));this.$tabList.append(u),o.css("height",s.height()-75+"px"),e(window).resize(function(){o.css("height",s.height()-75+"px"),o.scrollTop(o[0].scrollHeight)}),u.bind("shown",function(){o.scrollTop(o[0].scrollHeight)}),e("#chiselchat-btn-room-user-list-"+t).bind("click",function(){return a.sortListLexicographically("#chiselchat-room-user-list-"+t),!1}),a.autoFocusTab?(this.focusTab(t),a.autoFocusTab=!1):a.resetNewMessageCount(t)},t.prototype.focusTab=function(e){if(this.$messages[e]){var t=this.$tabList.find("[data-room-id="+e+"]").find("a");t.length&&(t.first().trigger("click"),t.first().children(".chiselchat-new-count").html("0"))}},t.prototype.removeTab=function(e){delete this.$messages[e],this.$tabContent.find("[data-room-id="+e+"]").remove();var t=this.$tabList.find("[data-room-id="+e+"]"),n=t.hasClass("active");t.remove(),n&&this.$tabList.find("[data-toggle=tab]").first().trigger("click")},t.prototype.showMessage=function(t,n){var a=this,i={id:n.id,localtime:a.formatTime(n.timestamp),message:n.message||"",userId:n.userId,name:n.name,type:n.type||"default",isSelfMessage:a._user&&n.userId==a._user.id,disableActions:!a._user||n.userId==a._user.id,userIsModerator:a._chat.userIsModerator(),avatarUri:"",profileUri:""};i.message=_.map(i.message.split(" "),function(e){return a.urlPattern.test(e)||a.pseudoUrlPattern.test(e)?a.linkify(encodeURI(e)):_.escape(e)}).join(" "),i.message=a.trimWithEllipsis(i.message,a.maxLengthMessage);var r=ChiselchatDefaultTemplates["templates/message.html"],s=e(r(i)),o=a.$messages[t];if(o){var c=!1;o.scrollTop()/(o[0].scrollHeight-o[0].offsetHeight)>=.95?c=!0:o[0].scrollHeight<=o.height()&&(c=!0),o.append(s);var l=this.$tabList.find("[data-room-id="+t+"]").find("a");l.length&&l.first().children(".chiselchat-new-count").html(parseInt(l.first().children(".chiselchat-new-count").html(),10)+1),c&&o.scrollTop(o[0].scrollHeight)}},t.prototype.removeMessage=function(t,n){e('.chiselchat-message[data-message-id="'+n+'"]').remove()},t.prototype.sortListLexicographically=function(t){e(t).children("li").sort(function(t,n){var a=e(t).text().toUpperCase(),i=e(n).text().toUpperCase();return i>a?-1:a>i?1:0}).appendTo(t)},t.prototype.trimWithEllipsis=function(e,t){return e=e.replace(/^\s\s*/,"").replace(/\s\s*$/,""),t&&t>=e.length?e:e.substring(0,t)+"..."},t.prototype.formatTime=function(e){var t=e?new Date(e):new Date,n=t.getHours()||12,a=""+t.getMinutes(),i=t.getHours()>=12?"pm":"am";return n=n>12?n-12:n,a=2>a.length?"0"+a:a,""+n+":"+a+i},t.prototype.linkify=function(e){var t=this;return e.replace(t.urlPattern,'<a target="_blank" href="$&">$&</a>').replace(t.pseudoUrlPattern,'$1<a target="_blank" href="http://$2">$2</a>')}}(jQuery);
